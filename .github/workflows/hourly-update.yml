name: Hourly Update

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿæ‰§è¡Œï¼ˆå³æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-tweets:
    name: èŽ·å–æœ€æ–°æŽ¨æ–‡
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´è¿è¡Œ
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
          
      - name: Setup Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Verify AUTH_TOKEN is configured
        run: |
          if [ -z "${{ secrets.AUTH_TOKEN }}" ]; then
            echo "âŒ é”™è¯¯: AUTH_TOKEN Secret æœªé…ç½®ï¼"
            echo ""
            echo "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š"
            echo "1. è¿›å…¥ä»“åº“ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. ç‚¹å‡» New repository secret"
            echo "3. Name: AUTH_TOKEN"
            echo "4. Secret: ä½ çš„ auth_token å€¼"
            exit 1
          else
            echo "âœ… AUTH_TOKEN å·²é…ç½®"
            echo "Token é•¿åº¦: ${#AUTH_TOKEN}"
          fi
        env:
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
        
      - name: Fetch latest tweets
        env:
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: |
          echo "å¼€å§‹èŽ·å–æœ€æ–°æŽ¨æ–‡..."
          echo "Token å‰10ä½: ${AUTH_TOKEN:0:10}..."
          bun run scripts/fetch-tweets.ts
          echo "æŽ¨æ–‡èŽ·å–å®Œæˆ"
        
      - name: Send to Flask Server
        if: always()  # æ— è®ºæŽ¨æ–‡èŽ·å–æ˜¯å¦æˆåŠŸï¼Œéƒ½å°è¯•å‘é€
        env:
          FLASK_API_URL: ${{ secrets.FLASK_API_URL }}
          FLASK_API_KEY: ${{ secrets.FLASK_API_KEY }}
        run: |
          if [ -z "$FLASK_API_URL" ] || [ -z "$FLASK_API_KEY" ]; then
            echo "âš ï¸ Flask æœåŠ¡å™¨é…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡å‘é€"
            echo "å¦‚éœ€å¯ç”¨ï¼Œè¯·é…ç½® FLASK_API_URL å’Œ FLASK_API_KEY Secrets"
          else
            echo "ðŸš€ å‘é€æ•°æ®åˆ° Flask æœåŠ¡å™¨..."
            bun run scripts/send-to-server.ts || echo "âš ï¸ å‘é€åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          fi
        
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          fi
        
      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          git add tweets/ accounts/ || true
          git commit -m "chore: update tweets [skip ci] - $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git push || echo "æŽ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰å˜æ›´"
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "- âœ… æ•°æ®å·²æ›´æ–°å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ æ²¡æœ‰æ–°æ•°æ®" >> $GITHUB_STEP_SUMMARY
          fi

